<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>貓語翻譯機 - Cat Whisperer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body style="font-family:sans-serif;text-align:center;padding:2em">
  <h1>🐾 Cat Whisperer - 貓語翻譯機（智慧版）</h1>
  <input type="file" accept="image/*,video/*" onchange="handleUpload(this)" />
  <canvas id="canvas" style="display:none;"></canvas>
  <br><img id="preview" style="max-width:300px; margin-top:1em" />
  <h3>📋 分析結果：</h3>
  <textarea id="result" readonly style="width:90%;height:100px;background:#fff7e6;"></textarea>
  <br><button onclick="speakResult()">🔊 播放語音</button>

  <script>
    let base64 = "", mediaType = "image";

    function handleUpload(input) {
      const file = input.files[0];
      mediaType = file.type.startsWith("video") ? "video" : "image";
      const reader = new FileReader();
      reader.onloadend = () => {
        if (mediaType === "image") {
          const img = new Image();
          img.onload = () => {
            const canvas = document.getElementById("canvas");
            let w = img.width, h = img.height, maxSize = 512;
            if (w > h && w > maxSize) { h *= maxSize / w; w = maxSize; }
            else if (h > maxSize) { w *= maxSize / h; h = maxSize; }
            canvas.width = w; canvas.height = h;
            canvas.getContext("2d").drawImage(img, 0, 0, w, h);
            base64 = canvas.toDataURL("image/jpeg", 0.7);
            document.getElementById("preview").src = base64;
            setTimeout(analyze, 500);
          };
          img.src = reader.result;
        } else {
          alert("目前只支援圖片，影片分析即將推出！");
        }
      };
      reader.readAsDataURL(file);
    }

    async function analyze() {
      document.getElementById("result").value = "🧠 分析中...";
      try {
        const res = await fetch("/analyze", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({
            image_base64: base64,
            prompt: "請判斷這隻貓的行為情緒並以擬人方式呈現"
          })
        });
        const data = await res.json();
        document.getElementById("result").value = data.result || "❌ 分析失敗";
      } catch {
        document.getElementById("result").value = "⚠️ 後端無回應，請稍後再試";
      }
    }

    function speakResult() {
      const text = document.getElementById("result").value;
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "zh-TW";
      // 根據情緒字詞調整語氣
      const seriousWords = ["痛", "焦慮", "不安", "緊張", "攻擊", "威脅", "生病", "退縮"];
      const tone = seriousWords.some(word => text.includes(word)) ? "serious" : "sweet";
      utterance.pitch = tone === "sweet" ? 1.3 : 0.9;
      utterance.rate = tone === "sweet" ? 1.05 : 0.95;
      utterance.volume = 1;
      speechSynthesis.speak(utterance);
    }
  </script>
</body>
</html>
