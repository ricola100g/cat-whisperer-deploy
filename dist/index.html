<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>è²“èªç¿»è­¯æ©Ÿ - Cat Whisperer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body style="font-family:sans-serif;text-align:center;padding:2em">
  <h1>ğŸ¾ Cat Whisperer - è²“èªç¿»è­¯æ©Ÿï¼ˆæ™ºæ…§ç‰ˆï¼‰</h1>
  <input type="file" accept="image/*,video/*" onchange="handleUpload(this)" />
  <canvas id="canvas" style="display:none;"></canvas>
  <br><img id="preview" style="max-width:300px; margin-top:1em" />
  <h3>ğŸ“‹ åˆ†æçµæœï¼š</h3>
  <textarea id="result" readonly style="width:90%;height:100px;background:#fff7e6;"></textarea>
  <br><button onclick="speakResult()">ğŸ”Š æ’­æ”¾èªéŸ³</button>

  <script>
    let base64 = "", mediaType = "image";

    function handleUpload(input) {
      const file = input.files[0];
      mediaType = file.type.startsWith("video") ? "video" : "image";
      const reader = new FileReader();
      reader.onloadend = () => {
        if (mediaType === "image") {
          const img = new Image();
          img.onload = () => {
            const canvas = document.getElementById("canvas");
            let w = img.width, h = img.height, maxSize = 512;
            if (w > h && w > maxSize) { h *= maxSize / w; w = maxSize; }
            else if (h > maxSize) { w *= maxSize / h; h = maxSize; }
            canvas.width = w; canvas.height = h;
            canvas.getContext("2d").drawImage(img, 0, 0, w, h);
            base64 = canvas.toDataURL("image/jpeg", 0.7);
            document.getElementById("preview").src = base64;
            setTimeout(analyze, 500);
          };
          img.src = reader.result;
        } else {
          alert("ç›®å‰åªæ”¯æ´åœ–ç‰‡ï¼Œå½±ç‰‡åˆ†æå³å°‡æ¨å‡ºï¼");
        }
      };
      reader.readAsDataURL(file);
    }

    async function analyze() {
      document.getElementById("result").value = "ğŸ§  åˆ†æä¸­...";
      try {
        const res = await fetch("/analyze", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({
            image_base64: base64,
            prompt: "è«‹åˆ¤æ–·é€™éš»è²“çš„è¡Œç‚ºæƒ…ç·’ä¸¦ä»¥æ“¬äººæ–¹å¼å‘ˆç¾"
          })
        });
        const data = await res.json();
        document.getElementById("result").value = data.result || "âŒ åˆ†æå¤±æ•—";
      } catch {
        document.getElementById("result").value = "âš ï¸ å¾Œç«¯ç„¡å›æ‡‰ï¼Œè«‹ç¨å¾Œå†è©¦";
      }
    }

    function speakResult() {
      const text = document.getElementById("result").value;
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "zh-TW";
      // æ ¹æ“šæƒ…ç·’å­—è©èª¿æ•´èªæ°£
      const seriousWords = ["ç—›", "ç„¦æ…®", "ä¸å®‰", "ç·Šå¼µ", "æ”»æ“Š", "å¨è„…", "ç”Ÿç—…", "é€€ç¸®"];
      const tone = seriousWords.some(word => text.includes(word)) ? "serious" : "sweet";
      utterance.pitch = tone === "sweet" ? 1.3 : 0.9;
      utterance.rate = tone === "sweet" ? 1.05 : 0.95;
      utterance.volume = 1;
      speechSynthesis.speak(utterance);
    }
  </script>
</body>
</html>
