<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Cat Whisperer - CORS æ”¯æ´ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <h1>ğŸ¾ Cat Whisperer æ¸¬è©¦ç‰ˆï¼ˆæ”¯æ´ CORSï¼‰</h1>
  <input type="file" accept="image/*" onchange="handleUpload(this)" />
  <canvas id="canvas" style="display:none;"></canvas>
  <img id="preview" />
  <button onclick="analyze()">é–‹å§‹åˆ†æ</button>
  <textarea id="result" readonly>è«‹é¸æ“‡åœ–ç‰‡ä¸¦æŒ‰ä¸‹ã€Œé–‹å§‹åˆ†æã€</textarea>

  <script>
    let base64 = "";
    function handleUpload(input) {
      const file = input.files[0];
      const reader = new FileReader();
      reader.onloadend = () => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.getElementById("canvas");
          let w = img.width, h = img.height, maxSize = 512;
          if (w > h && w > maxSize) { h *= maxSize / w; w = maxSize; }
          else if (h > maxSize) { w *= maxSize / h; h = maxSize; }
          canvas.width = w; canvas.height = h;
          canvas.getContext("2d").drawImage(img, 0, 0, w, h);
          base64 = canvas.toDataURL("image/jpeg", 0.7);
          document.getElementById("preview").src = base64;
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    }

    async function analyze() {
      if (!base64) {
        document.getElementById("result").value = "è«‹å…ˆä¸Šå‚³åœ–ç‰‡";
        return;
      }
      document.getElementById("result").value = "åˆ†æä¸­...";
      try {
        const res = await fetch("https://cat-whisperer-deploy.onrender.com/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            image_base64: base64,
            prompt: "è«‹ç¿»è­¯é€™éš»è²“ç¾åœ¨çš„å¿ƒæƒ…ï¼ˆç¹é«”ä¸­æ–‡ï¼‰"
          })
        });
        const data = await res.json();
        document.getElementById("result").value = data.result || "âŒ ç„¡æ³•è§£æå›æ‡‰";
      } catch (e) {
        document.getElementById("result").value = "âš ï¸ ç„¡æ³•é€£ç·šåˆ°å¾Œç«¯ï¼Œè«‹ç¨å¾Œå†è©¦";
      }
    }
  </script>
</body>
</html>
