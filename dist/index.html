<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Cat Whisperer Gemini</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <h1>🐾 Cat Whisperer - Gemini Vision 全功能版</h1>
  <input type="file" accept="image/*" onchange="handleUpload(this); setTimeout(analyze, 500);" />
  <canvas id="canvas" style="display:none;"></canvas>
  <img id="preview" />
  <textarea id="result" readonly style="width:90%;height:100px;">請上傳貓咪圖片，自動分析中...</textarea>
  <br/>
  <button onclick="speakResult()">🔈 播放聲音</button>

  <script>
    let base64 = "";
    function handleUpload(input) {
      const file = input.files[0];
      const reader = new FileReader();
      reader.onloadend = () => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.getElementById("canvas");
          let w = img.width, h = img.height, maxSize = 512;
          if (w > h && w > maxSize) { h *= maxSize / w; w = maxSize; }
          else if (h > maxSize) { w *= maxSize / h; h = maxSize; }
          canvas.width = w; canvas.height = h;
          canvas.getContext("2d").drawImage(img, 0, 0, w, h);
          base64 = canvas.toDataURL("image/jpeg", 0.7);
          document.getElementById("preview").src = base64;
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    }

    async function analyze() {
      if (!base64) return;
      document.getElementById("result").value = "🐱 Gemini 分析中...";
      try {
        const res = await fetch("/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            image_base64: base64,
            prompt: "這隻貓目前的心情是什麼？請用可愛、擬人語氣描述牠的感受，使用繁體中文。"
          })
        });
        const data = await res.json();
        document.getElementById("result").value = data.result || "❌ 沒有收到分析結果";
      } catch (e) {
        document.getElementById("result").value = "⚠️ 無法連線到後端，請稍後再試";
      }
    }

    function speakResult() {
      const text = document.getElementById("result").value;
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "zh-TW";
      utterance.pitch = 1.2;
      utterance.rate = 1;
      speechSynthesis.speak(utterance);
    }
  </script>
</body>
</html>
